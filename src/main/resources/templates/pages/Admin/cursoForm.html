<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${curso.id} != null ? 'Editar Curso' : 'Registro de Curso'">Registro de Curso</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@1.5.1/dist/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/css/stylesF.css}" />
</head>
<body class="bg-gradient-to-br from-blue-100 to-blue-200">

<nav class="bg-gradient-to-r from-blue-700 via-blue-800 to-blue-900 backdrop-blur-md bg-opacity-90 shadow-2xl fixed w-full top-0 left-0 z-50 px-7">
    <div class="max-w-7xl mx-auto px-4 py-2 flex justify-between items-center">

        <!-- Logo e Institución -->
        <div class="flex items-center space-x-3">
            <img src="/img/logoUE.jpg" alt="Logo" class="w-16 h-16 rounded-full border border-white shadow-md transition-transform hover:scale-105 duration-300">

            <div class="text-white leading-tight">
                <p class="text-lg font-bold tracking-wide">
                    UNIDAD EDUCATIVA PARTICULAR "LINCOLN LARREA BENALCÁZAR"
                </p>
                <p class="text-lg text-yellow-300 font-semibold pt-1" th:text="${curso.id} != null ? 'Editar Curso' : 'Formulario de Curso'">
                    Formulario de Curso
                </p>
            </div>
        </div>


        <!-- Botón de regreso -->
        <a th:href="@{/pages/Admin/cursoVista}"
           class="flex items-center gap-2 text-blue-800 bg-white hover:bg-blue-100 px-5 py-2 rounded-full font-semibold shadow-lg transition-transform transform hover:scale-105 duration-300">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            <span>Regresar</span>
        </a>

    </div>
</nav>



<section class="flex justify-center mt-10 px-4 pb-10 mb-20 pt-20 pb-20">
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl p-10">

        <!-- Título general amarillo -->
        <h2 class="text-4xl font-extrabold text-yellow-600 mb-10 text-center">
            Proceso para generar curso
        </h2>

        <!-- Contenedor filtro: ancho completo con margen vertical -->
        <div class="bg-purple-200 rounded-lg shadow-inner w-full my-4 p-6">

            <h3 class="text-3xl font-bold text-purple-800 mb-6 text-center">
                1. Filtro de información
            </h3>

            <form id="formFiltro"
                  th:action="${curso.id} != null ? @{/pages/Admin/cursoForm/{id}(id=${curso.id})} : @{/pages/Admin/cursoForm}"
                  method="get"
                  class="space-y-6">

                <div>
                    <label for="nivelSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        Nivel educativo (filtra Materias y Estudiantes)
                    </label>
                    <select id="nivelSelect" name="nivelId"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition">
                        <option value="">Todos los niveles</option>
                        <option th:each="nivel : ${niveles}"
                                th:value="${nivel.id}"
                                th:text="${nivel.nombre}"
                                th:selected="${nivel.id == nivelSeleccionado}">
                        </option>
                    </select>
                </div>

                <div class="flex justify-center">
                    <button type="submit"
                            class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                        Aplicar filtro
                    </button>
                </div>

            </form>
        </div>

        <div th:if="${!filtroAplicado}" class="mb-6 p-4 bg-red-100 border border-red-400 text-red-800 rounded-lg max-w-3xl mx-auto text-center font-semibold">
            Debes seleccionar un nivel y aplicar el filtro antes de crear un curso.
        </div>

        <!-- Mostrar mensaje de error -->
        <div th:if="${error}" class="mb-6 p-4 bg-red-100 border border-red-400 text-red-800 rounded-lg text-center font-semibold">
            <span th:text="${error}"></span>
        </div>

        <!-- Crear/Editar Curso -->
        <div class="bg-blue-200 rounded-lg p-8 max-w-full mx-auto">

            <h3 class="text-3xl font-bold text-black mb-6 text-center"
                th:text="${curso.id} != null ? '2. Editar Curso' : '2. Crear Curso'">
            </h3>

            <form id="formCrearCurso"
                  th:action="@{/pages/Admin/cursoGuardar}"
                  method="post"
                  th:object="${curso}"
                  class="space-y-6">

                <input type="hidden" th:field="*{id}" />

                <!-- Nombre -->
                <div>
                    <label for="nombre" class="block text-sm font-semibold text-black mb-1">Nombre del Curso</label>
                    <input type="text" id="nombre" th:field="*{nombre}"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition"
                           placeholder="Ej: 1ro BG A / Segundo Bachillerato" />
                    <span th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}" class="error-message text-red-600"></span>
                </div>

                <!-- Periodo Académico -->
                <div>
                    <label for="periodoSelectForm" class="block text-sm font-semibold text-black mb-1">
                        Periodo Académico
                    </label>
                    <select id="periodoSelectForm" th:field="*{periodoAcademico.id}"  required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition">
                        <option value="">-- Seleccione periodo --</option>
                        <option th:each="per : ${periodos}"
                                th:value="${per.id}"
                                th:text="${per.nombre}">
                        </option>
                    </select>
                    <span th:if="${#fields.hasErrors('periodoAcademico.id')}" th:errors="*{periodoAcademico.id}" class="error-message text-red-600"></span>
                </div>

                <!-- Nivel educativo -->
                <div>
                    <label for="nivelSelectForm" class="block text-sm font-semibold text-black mb-1">
                        Nivel educativo
                    </label>
                    <select id="nivelSelectForm" th:field="*{nivelEducativo.id}"  required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none transition">
                        <option value="">-- Seleccione nivel --</option>
                        <option th:each="nivel : ${niveles}"
                                th:value="${nivel.id}"
                                th:text="${nivel.nombre}">
                        </option>
                    </select>
                    <span th:if="${#fields.hasErrors('nivelEducativo.id')}" th:errors="*{nivelEducativo.id}" class="error-message text-red-600"></span>
                </div>

                <!-- Materias filtradas -->
                <div>
                    <label for="materiasSeleccionadas" class="block text-sm font-medium text-black mb-1">
                        Materias del Curso
                    </label>
                    <select id="materiasSeleccionadas"
                            name="materiasSeleccionadas"
                            multiple
                            size="6"
                            class="w-full px-3 py-2 border border-blue-400 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm transition">
                        <option th:each="materia : ${materias}"
                                th:value="${materia.id}"
                                th:text="${materia.nombre + ' (' + (materia.tipoMateria != null ? materia.tipoMateria : 'NORMAL') + ')'}"
                                th:selected="${curso.materias != null and #lists.contains(curso.materias, materia)}">
                        </option>
                    </select>
                    <span th:if="${#fields.hasErrors('materias')}" th:errors="*{materias}" class="error-message text-red-600"></span>
                    <p class="text-sm text-black mt-2">Ctrl / Cmd para selección múltiple.</p>
                </div>

                <!-- Estudiantes filtrados -->
                <div>
                    <label for="estudiantesSeleccionados" class="block text-sm font-medium text-black mb-1">
                        Estudiantes inscritos
                    </label>
                    <select id="estudiantesSeleccionados"
                            name="estudiantesSeleccionados"
                            multiple
                            size="6"
                            class="w-full px-3 py-2 border border-green-400 rounded-lg bg-white focus:ring-2 focus:ring-green-500 focus:outline-none shadow-sm transition">
                        <option th:each="est : ${estudiantes}"
                                th:value="${est.id}"
                                th:text="${est.cedula + ' - ' + est.nombre}"
                                th:selected="${curso.estudiantes != null and #lists.contains(curso.estudiantes, est)}">
                        </option>
                    </select>
                    <p class="text-sm text-black mt-2">Ctrl / Cmd para selección múltiple.</p>
                </div>

                <button type="submit"
                        class="bg-green-600 text-white w-1/2 py-3 rounded hover:bg-green-700 transition mx-auto block">
                    [[${curso.id} != null ? 'Actualizar Curso' : 'Registrar Curso']]
                </button>
            </form>
        </div>
    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/flowbite@1.5.1/dist/flowbite.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const nivelSelect = document.getElementById('nivelSelect');
      const formCrear = document.getElementById('formCrearCurso');
      const inputs = formCrear.querySelectorAll('input, select, button[type="submit"]');

      function setDisabledStatus() {
        const nivelSeleccionado = nivelSelect.value.trim() !== '';
        inputs.forEach(el => {
          // Siempre habilitar el botón submit del filtro (pero no está dentro de formCrear)
          // En formCrear deshabilitar todo si nivel no seleccionado
          if (el.type !== 'hidden') {
            el.disabled = !nivelSeleccionado;
          }
        });
      }

      setDisabledStatus();

      // Opcional: cuando cambie el filtro, si cambia el nivel, actualizar
      nivelSelect.addEventListener('change', setDisabledStatus);
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
      const formCrear = document.getElementById('formCrearCurso');

      // Campos que validar
      const inputNombre = formCrear.querySelector('input#nombre');
      const selectPeriodo = formCrear.querySelector('select#periodoSelectForm');
      const selectNivel = formCrear.querySelector('select#nivelSelectForm');
      const selectMaterias = formCrear.querySelector('select#materiasSeleccionadas');
      const selectEstudiantes = formCrear.querySelector('select#estudiantesSeleccionados');
      const btnSubmit = formCrear.querySelector('button[type="submit"]');

      // Función para validar si hay al menos una opción seleccionada en select multiple
      function tieneSeleccionMultiple(selectElement) {
        return Array.from(selectElement.options).some(option => option.selected);
      }

      function validarFormulario() {
        const nombreValido = inputNombre.value.trim() !== '';
        const periodoValido = selectPeriodo.value.trim() !== '';
        const nivelValido = selectNivel.value.trim() !== '';
        const materiasValidas = tieneSeleccionMultiple(selectMaterias);
        const estudiantesValidos = tieneSeleccionMultiple(selectEstudiantes);

        const todoValido = nombreValido && periodoValido && nivelValido && materiasValidas && estudiantesValidos;

        btnSubmit.disabled = !todoValido;

        // Cambiar colores del botón según estado habilitado o deshabilitado
        if (todoValido) {
          btnSubmit.classList.remove('bg-gray-400', 'cursor-not-allowed');
          btnSubmit.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
        } else {
          btnSubmit.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
          btnSubmit.classList.add('bg-gray-400', 'cursor-not-allowed');
        }
      }

      // Validar inicialmente al cargar la página
      validarFormulario();

      // Añadir listeners para validar en cada cambio o entrada
      inputNombre.addEventListener('input', validarFormulario);
      selectPeriodo.addEventListener('change', validarFormulario);
      selectNivel.addEventListener('change', validarFormulario);
      selectMaterias.addEventListener('change', validarFormulario);
      selectEstudiantes.addEventListener('change', validarFormulario);
    });
</script>


</body>
</html>
