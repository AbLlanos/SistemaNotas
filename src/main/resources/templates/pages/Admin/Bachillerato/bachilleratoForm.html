<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${nota.idNota} != null ? 'Editar Nota' : 'Crear Nota'">Nota</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6">

<h1 class="text-2xl font-bold mb-4" th:text="${nota.idNota} != null ? 'Editar Nota' : 'Crear Nota'"></h1>

<form th:action="@{/pages/Admin/notas/guardar}" method="post" class="space-y-6 max-w-3xl">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

    <input type="hidden" name="idNota" th:if="${nota.idNota != null}" th:value="${nota.idNota}"/>

    <!-- ======== Estudiante ======== -->
    <div>
        <label for="cedulaEstudiante" class="block mb-1 text-sm font-semibold">Estudiante</label>
        <select id="cedulaEstudiante" name="cedulaEstudiante"
                th:disabled="${nota.idNota != null}" required
                class="w-full border rounded px-3 py-2 text-sm">
            <option value=""
                    th:selected="${#strings.isEmpty(nota.cedulaEstudiante)}">-- Seleccione un estudiante --</option>
            <option th:each="est : ${estudiantes}"
                    th:value="${est.cedula}"
                    th:text="${est.cedula + ' - ' + est.nombre + ' ' + est.apellido}"
                    th:selected="${est.cedula == nota.cedulaEstudiante}">
            </option>
        </select>
        <input type="hidden" name="cedulaEstudiante" th:if="${nota.idNota != null}" th:value="${nota.cedulaEstudiante}"/>
    </div>

    <!-- ======== Curso ======== -->
    <div>
        <label for="cursoSelect" class="block mb-1 text-sm font-semibold">Curso</label>
        <select id="cursoSelect" name="cursoId" th:disabled="${nota.idNota != null}"
                class="w-full border rounded px-3 py-2 text-sm">
            <option value="" data-nombre="" data-periodo="">-- Seleccione un curso --</option>
            <option th:each="cur : ${cursos}"
                    th:value="${cur.id}"
                    th:attr="data-nombre=${cur.nombre},data-periodo=${cur.periodoAcademico?.nombre}"
                    th:text="${cur.nombre}"
                    th:selected="${cur.nombre == nota.nombreCurso}">
            </option>
        </select>
        <input type="hidden" id="nombreCursoHidden"   name="nombreCurso"   th:value="${nota.nombreCurso}"/>
        <input type="hidden" id="nombrePeriodoHidden" name="nombrePeriodo" th:value="${nota.nombrePeriodo}"/>
    </div>

    <!-- ======== Materia dependiente de Curso ======== -->
    <div>
        <label for="areaMateria" class="block mb-1 text-sm font-semibold">Materia</label>
        <select id="areaMateria" name="materiaId" th:disabled="${nota.idNota != null}" required
                class="w-full border rounded px-3 py-2 text-sm">
            <option value="" data-nombre="">-- Seleccione una materia --</option>
            <option th:if="${nota.idNota != null}"
                    th:value="${nota.materiaId}"  <!-- asegúrate de setear materiaId en el DTO al editar -->
            th:attr="data-nombre=${nota.areaMateria}"
            th:text="${nota.areaMateria}" selected>
            </option>
        </select>
        <input type="hidden" id="materiaNombreHidden" name="areaMateria" th:value="${nota.areaMateria}"/>
    </div>

    <hr class="my-4"/>

    <!-- ======= Primer Trimestre ======= -->
    <h3 class="text-lg font-semibold">Primer Trimestre</h3>
    <div class="grid grid-cols-2 gap-4">
        <!-- Nota num -->
        <div>
            <label for="notaNumerica1" class="block text-xs font-semibold">Nota Numérica</label>
            <input type="number" step="0.01" id="notaNumerica1" name="notaNumericaPrimerTrim"
                   th:value="${nota.notaNumericaPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <!-- Nota cual -->
        <div>
            <label for="notaCualitativa1" class="block text-xs font-semibold">Nota Cualitativa</label>
            <input type="text" id="notaCualitativa1" name="notaCualitativaPrimerTrim"
                   th:value="${nota.notaCualitativaPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <!-- Asist -->
        <div>
            <label for="asistencia1" class="block text-xs font-semibold">Asistencias</label>
            <input type="number" id="asistencia1" name="asistenciaPrimerTrim"
                   th:value="${nota.asistenciaPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <!-- Faltas J -->
        <div>
            <label for="faltasJustificadas1" class="block text-xs font-semibold">Faltas Just.</label>
            <input type="number" id="faltasJustificadas1" name="faltasJustificadasPrimerTrim"
                   th:value="${nota.faltasJustificadasPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <!-- Faltas I -->
        <div>
            <label for="faltasInjustificadas1" class="block text-xs font-semibold">Faltas Injust.</label>
            <input type="number" id="faltasInjustificadas1" name="faltasInjustificadasPrimerTrim"
                   th:value="${nota.faltasInjustificadasPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <!-- Atrasos -->
        <div>
            <label for="atrasos1" class="block text-xs font-semibold">Atrasos</label>
            <input type="number" id="atrasos1" name="atrasosPrimerTrim"
                   th:value="${nota.atrasosPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <!-- Comportamiento -->
        <div class="col-span-2">
            <label for="comportamiento1" class="block text-xs font-semibold">Comportamiento</label>
            <input type="text" id="comportamiento1" name="comportamientoPrimerTrim"
                   th:value="${nota.comportamientoPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <!-- Total -->
        <div>
            <label for="totalAsistencias1" class="block text-xs font-semibold">Total Asistencias</label>
            <input type="number" id="totalAsistencias1" name="totalAsistenciaPrimerTrim"
                   th:value="${nota.totalAsistenciaPrimerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
    </div>

    <!-- ======= Segundo Trimestre ======= -->
    <h3 class="text-lg font-semibold mt-6">Segundo Trimestre</h3>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label for="notaNumerica2" class="block text-xs font-semibold">Nota Numérica</label>
            <input type="number" step="0.01" id="notaNumerica2" name="notaNumericaSegundoTrim"
                   th:value="${nota.notaNumericaSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="notaCualitativa2" class="block text-xs font-semibold">Nota Cualitativa</label>
            <input type="text" id="notaCualitativa2" name="notaCualitativaSegundoTrim"
                   th:value="${nota.notaCualitativaSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="asistencia2" class="block text-xs font-semibold">Asistencias</label>
            <input type="number" id="asistencia2" name="asistenciaSegundoTrim"
                   th:value="${nota.asistenciaSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="faltasJustificadas2" class="block text-xs font-semibold">Faltas Just.</label>
            <input type="number" id="faltasJustificadas2" name="faltasJustificadasSegundoTrim"
                   th:value="${nota.faltasJustificadasSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="faltasInjustificadas2" class="block text-xs font-semibold">Faltas Injust.</label>
            <input type="number" id="faltasInjustificadas2" name="faltasInjustificadasSegundoTrim"
                   th:value="${nota.faltasInjustificadasSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="atrasos2" class="block text-xs font-semibold">Atrasos</label>
            <input type="number" id="atrasos2" name="atrasosSegundoTrim"
                   th:value="${nota.atrasosSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div class="col-span-2">
            <label for="comportamiento2" class="block text-xs font-semibold">Comportamiento</label>
            <input type="text" id="comportamiento2" name="comportamientoSegundoTrim"
                   th:value="${nota.comportamientoSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="totalAsistencias2" class="block text-xs font-semibold">Total Asistencias</label>
            <input type="number" id="totalAsistencias2" name="totalAsistenciaSegundoTrim"
                   th:value="${nota.totalAsistenciaSegundoTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
    </div>

    <!-- ======= Tercer Trimestre ======= -->
    <h3 class="text-lg font-semibold mt-6">Tercer Trimestre</h3>
    <div class="grid grid-cols-2 gap-4">
        <div>
            <label for="notaNumerica3" class="block text-xs font-semibold">Nota Numérica</label>
            <input type="number" step="0.01" id="notaNumerica3" name="notaNumericaTercerTrim"
                   th:value="${nota.notaNumericaTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="notaCualitativa3" class="block text-xs font-semibold">Nota Cualitativa</label>
            <input type="text" id="notaCualitativa3" name="notaCualitativaTercerTrim"
                   th:value="${nota.notaCualitativaTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="asistencia3" class="block text-xs font-semibold">Asistencias</label>
            <input type="number" id="asistencia3" name="asistenciaTercerTrim"
                   th:value="${nota.asistenciaTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="faltasJustificadas3" class="block text-xs font-semibold">Faltas Just.</label>
            <input type="number" id="faltasJustificadas3" name="faltasJustificadasTercerTrim"
                   th:value="${nota.faltasJustificadasTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="faltasInjustificadas3" class="block text-xs font-semibold">Faltas Injust.</label>
            <input type="number" id="faltasInjustificadas3" name="faltasInjustificadasTercerTrim"
                   th:value="${nota.faltasInjustificadasTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="atrasos3" class="block text-xs font-semibold">Atrasos</label>
            <input type="number" id="atrasos3" name="atrasosTercerTrim"
                   th:value="${nota.atrasosTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div class="col-span-2">
            <label for="comportamiento3" class="block text-xs font-semibold">Comportamiento</label>
            <input type="text" id="comportamiento3" name="comportamientoTercerTrim"
                   th:value="${nota.comportamientoTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
        <div>
            <label for="totalAsistencias3" class="block text-xs font-semibold">Total Asistencias</label>
            <input type="number" id="totalAsistencias3" name="totalAsistenciaTercerTrim"
                   th:value="${nota.totalAsistenciaTercerTrim}" class="w-full border rounded px-2 py-1"/>
        </div>
    </div>

    <div class="pt-6">
        <button type="submit"
                class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded">
            <span th:text="${nota.idNota != null ? 'Actualizar' : 'Guardar'}">Guardar</span>
        </button>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const cursoSelect         = document.getElementById('cursoSelect');
      const nombreCursoHidden   = document.getElementById('nombreCursoHidden');
      const nombrePeriodoHidden = document.getElementById('nombrePeriodoHidden');

      const materiaSelect       = document.getElementById('areaMateria');
      const materiaNombreHidden = document.getElementById('materiaNombreHidden');

      const estudianteSelect    = document.getElementById('cedulaEstudiante');

      // --- Curso cambia -> cargar materias & estudiantes y setear periodo ---
      cursoSelect?.addEventListener('change', function() {
        const cursoId     = this.value;
        const cursoNombre = this.options[this.selectedIndex]?.dataset?.nombre   || '';
        const cursoPeriodo= this.options[this.selectedIndex]?.dataset?.periodo || '';

        nombreCursoHidden.value   = cursoNombre;
        nombrePeriodoHidden.value = cursoPeriodo;

        if (!cursoId) {
          materiaSelect.innerHTML    = '<option value="" data-nombre="">-- Seleccione una materia --</option>';
          materiaNombreHidden.value  = '';
          estudianteSelect.innerHTML = '<option value="">-- Seleccione un estudiante --</option>';
          return;
        }

        // Materias
        materiaSelect.innerHTML = '<option value="" data-nombre="">Cargando...</option>';
        fetch(`/pages/Admin/${cursoId}/materias`)
          .then(r => { if (!r.ok) throw new Error('Error al consultar materias'); return r.json(); })
          .then(data => {
            materiaSelect.innerHTML = '<option value="" data-nombre="">-- Seleccione una materia --</option>';
            data.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m.id;
              opt.dataset.nombre = m.nombre;
              opt.textContent = m.nombre;
              materiaSelect.appendChild(opt);
            });
            materiaNombreHidden.value = '';
          })
          .catch(err => {
            console.error(err);
            materiaSelect.innerHTML = '<option value="" data-nombre="">(Error cargando materias)</option>';
          });

        // Estudiantes
        estudianteSelect.innerHTML = '<option value="">Cargando...</option>';
        fetch(`/pages/Admin/cursos/${cursoId}/estudiantes`)
          .then(r => { if (!r.ok) throw new Error('Error al consultar estudiantes'); return r.json(); })
          .then(data => {
            estudianteSelect.innerHTML = '<option value="">-- Seleccione un estudiante --</option>';
            data.forEach(e => {
              const opt = document.createElement('option');
              opt.value = e.cedula;
              opt.textContent = e.cedula + ' - ' + (e.nombreCompleto || '');
              estudianteSelect.appendChild(opt);
            });
          })
          .catch(err => {
            console.error(err);
            estudianteSelect.innerHTML = '<option value="">(Error cargando estudiantes)</option>';
          });
      });

      // --- Materia cambia -> sincroniza hidden nombre ---
      materiaSelect?.addEventListener('change', function() {
        const selectedOpt = this.options[this.selectedIndex];
        materiaNombreHidden.value = selectedOpt?.dataset?.nombre || '';
      });

      // --- Inicialización al editar ---
      (function initOnEdit() {
        const editing = document.querySelector('input[name="idNota"]') !== null;
        if (!editing) return;

        const cursoId = cursoSelect.value;
        if (!cursoId) return;

        // Forzamos a tomar dataset del curso preseleccionado (si existe)
        const selectedOpt = cursoSelect.options[cursoSelect.selectedIndex];
        nombreCursoHidden.value   = selectedOpt?.dataset?.nombre   || nombreCursoHidden.value;
        nombrePeriodoHidden.value = selectedOpt?.dataset?.periodo || nombrePeriodoHidden.value;

        // Cargar materias
        fetch(`/pages/Admin/${cursoId}/materias`)
          .then(r => r.json())
          .then(data => {
            const materiaActualNombre = materiaNombreHidden.value;
            materiaSelect.innerHTML = '<option value="" data-nombre="">-- Seleccione una materia --</option>';
            data.forEach(m => {
              const opt = document.createElement('option');
              opt.value = m.id;
              opt.dataset.nombre = m.nombre;
              opt.textContent = m.nombre;
              if (m.nombre === materiaActualNombre) opt.selected = true;
              materiaSelect.appendChild(opt);
            });
          })
          .catch(err => {
            console.error(err);
            materiaSelect.innerHTML = '<option value="" data-nombre="">(Error cargando materias)</option>';
          });

        // Cargar estudiantes
        fetch(`/pages/Admin/cursos/${cursoId}/estudiantes`)
          .then(r => r.json())
          .then(data => {
            const estudianteActual = estudianteSelect.value; // ya viene del form
            estudianteSelect.innerHTML = '<option value="">-- Seleccione un estudiante --</option>';
            data.forEach(e => {
              const opt = document.createElement('option');
              opt.value = e.cedula;
              opt.textContent = e.cedula + ' - ' + (e.nombreCompleto || '');
              if (e.cedula === estudianteActual) opt.selected = true;
              estudianteSelect.appendChild(opt);
            });
          })
          .catch(err => {
            console.error(err);
            estudianteSelect.innerHTML = '<option value="">(Error cargando estudiantes)</option>';
          });
      })();
    });
</script>

</body>
</html>
